name: CI

on:
  push:
    branches: [ main ]
    tags: [ "v*.*.*" ]
  pull_request:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: [20]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Sync commands
        run: npm run sync

      - name: Sync is idempotent
        shell: bash
        run: |
          git status --porcelain
          npm run sync
          # must be clean after second sync
          if [ -n "$(git status --porcelain)" ]; then
            echo "Sync is NOT idempotent. Working tree changed after running sync twice."
            git status --porcelain
            git diff
            exit 1
          fi

      - name: Verify Compatibility Matrix
        run: npm run verify:compat

  smoke-install:
    # Linux-only smoke test for bash installer
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Test Local Bash Installer
        shell: bash
        run: |
          set -euo pipefail
          # We simulate the install script by running the local version
          # but we need to set BRIDGE_ROOT to point to the current repo
          ./install.sh

      - name: Verify install artifacts
        shell: bash
        run: |
          # The install.sh installs to $HOME/.opencode/conductor-bridge
          test -d "$HOME/.opencode/conductor-bridge" || (echo "Missing bridge dir" && exit 1)
          test -f "$HOME/.opencode/conductor-bridge/package.json" || (echo "Missing package.json" && exit 1)

  smoke-npx:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Test Local Node Installer
        shell: bash
        run: |
          set -euo pipefail
          # Test running the installer directly from the source
          node bin/install.js

      - name: Verify install artifacts
        shell: bash
        run: |
          test -d "$HOME/.opencode/conductor-bridge" || (echo "Missing bridge dir" && exit 1)
